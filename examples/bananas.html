<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">

  <title>Bananas | Sprinkler Example</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    body {
      font-size: 16px;
      background: yellow;
      color: green;
    }

    a:link { text-decoration: underline; }
    a:visited { text-decoration: underline; }
    a:hover { text-decoration: none; }
    a:active { text-decoration: none; }

    #canvas {
      position: fixed;
      top: 0px;
      right: 0px;
      display: block;
      margin: 0;
      width: 100%;
      height: 100%;
    }

    .info {
      font-family: Verdana, Geneva, sans-serif;
      padding: 1rem;
      max-width: 16rem;
      position: relative;
      z-index: 1;
      user-select: none;
    }

    .info h1 {
      margin-top: 0;
      margin-bottom: 0;
    }

    .info p {
      margin-top: 0.79em;
      margin-bottom: 1.27em;
    }

    a:link { color: darkgreen; }
    a:visited { color: darkgreen; }
    a:hover { color: lightgreen; }

    #score {
      margin-bottom: 0;
    }
    #highscore {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <canvas id="canvas">
  </canvas>

  <div class="info">
    <h1>Drop Dem Bananas</h1>
    <p>Tap to drop, hit to score.</p>
    <h2 id="score"></h2>
    <h2 id="level"></h2>
    <p id="highscore"></p>
    <p id="prizes"></p>
    <p>Built with <a href="https://github.com/axelpale/sprinkler">sprinkler.js</a><br>
    Images from <a href="http://pngimg.com/download/805">pngimg.com</a></p>
  </div>

  <script src="https://unpkg.com/sprinkler@1.8.0/dist/sprinkler.min.js"></script>
  <script>
  (function () {
    var images = [
      'img/banana.png',
      'img/orange.png',
      'img/kiwi.png',
      'img/pear.png',
      'img/strawberry.png'
    ]
    var prizes = [
      1,
      10,
      100,
      1000,
      10000
    ]
    var weights = prizes.map(z => 1 / z)

    var c = document.getElementById('canvas')
    var s = sprinkler.create(c)

    // Render prizes
    var prizesEl = document.getElementById('prizes')
    prizesEl.innerHTML = 'Prizes:<br>' + images.map((url, i) => {
      var imgEl = '<img src="' + url + '" width="16" height="16">'
      return imgEl + ' ' + prizes[i]
    }).reverse().join('<br>')

    // Collect user score
    var score = 0
    var scoreEl = document.getElementById('score')
    var highscoreEl = document.getElementById('highscore')
    var addToScore = (points) => {
      score += points

      var highscore = parseInt(window.localStorage.getItem('highscore'))
      if (isNaN(highscore)) {
        highscore = 0
      }

      if (highscore < score) {
        highscore = score
        window.localStorage.setItem('highscore', highscore)
      }

      scoreEl.innerHTML = 'Score ' + score
      highscoreEl.innerHTML = 'Highscore ' + highscore
    }
    // Init score viewer
    addToScore(0)

    // Keep track of game level progression by keeping track of collected items
    var inventory = images.map(() => 0)
    var level = 0 // zero means only bananas are falling
    var levelEl = document.getElementById('level')
    var renderLevel = function (l) {
      levelEl.innerHTML = 'Level ' + l
    }
    var addToInventory = function (imageIndex) {
      inventory[imageIndex] += 1

      // Recompute level
      level = inventory.filter(item => item > 0).length

      renderLevel(level)
    }
    // Init lever viewer
    renderLevel(level)

    var clickModifier = function (p) {
      if (p.clicked) {
        return p
      }

      // Reward
      var particleIndex = images.indexOf(p.imageUrl)
      var prize = prizes[particleIndex]
      addToScore(prize)

      // Level progression
      addToInventory(particleIndex)

      // Set up image object for afterimage
      var img = new Image()
      img.src = 'img/star.png'

      // Build updated particle
      return Object.assign({}, p, {
        imageUrl: img.src,
        image: img,
        z: 0.2,
        clicked: true
      })
    }

    var clickHandler = function () {
      var imageDist = images.slice(0, level + 1).reduce((acc, url, i) => {
        acc[url] = weights[i]
        return acc
      }, {})

      var stop = s.start(imageDist, {
        imagesInSecond: 1,
        constantDensity: false,
        zMin: 0.38, zMax: 0.62,
        dyMin: 200, dyMax: 400,
        ddyMin: 20, ddyMax: 20,
        ddrMin: 2, ddrMax: 2,
        clickModifier: clickModifier
      })
      window.setTimeout(stop, 1000)
    }

    c.addEventListener('click', clickHandler)
  })()
  </script>

</body>
</html>
